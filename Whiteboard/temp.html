<!DOCTYPE html>
<html>
<head>
  <style>
    .tool {
      margin: 5px;
    }
    .context-menu {
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
      padding: 5px 0;
      width: 120px;
    }

    .context-menu ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    .context-menu li {
      cursor: pointer;
      padding: 5px 10px;
    }

    .context-menu li:hover {
      background-color: #f0f0f0;
    }
    #toolkit {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10001;
    }

  </style>
</head>
<body>
<div id="toolkit">
  <button class="tool" onclick="addShape('operation')">
    Add Operation
  </button>
  <button class="tool" onclick="addShape('role')">
    Add Role
  </button>
  <button class="tool" onclick="addShape('user')">
    Add User
  </button>
</div>

<script>
  let roleList = [];
  let operationList = [];
  let userList = [];
  let connections = [];

  function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    element.style.position = "absolute";
    element.style.left = "100px";
    element.style.top = "100px";

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      e.stopPropagation();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      /*if (e.button === 2) {
        const contextMenu = document.getElementById("contextMenu");
        contextMenu.style.display = "block";
        contextMenu.style.left = e.clientX + "px";
        contextMenu.style.top = e.clientY + "px";
      }
      else {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
      }*/
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      element.style.top = element.offsetTop - pos2 + "px";
      element.style.left = element.offsetLeft - pos1 + "px";

      // updateConnections();
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
      updateConnections();
    }

    element.onmousedown = dragMouseDown;
  }

  function addShape(tool) {
    let name = prompt(`Enter the name for the ${tool}:`);
    if (tool === "role" && roleList.some(c => c.name === name)) {
      alert(`The role ${name} already exists!`);
      return;
    }
    if (tool === "operation" && operationList.some(o => o.name === name)) {
      alert(`The operation ${name} already exists!`);
      return;
    }
    if (name === null) {
      return;
    }

    let shapeContainer = document.createElement("div");
    shapeContainer.style.position = "absolute";
    shapeContainer.style.zIndex = "10";
    shapeContainer.style.left = "100px";
    shapeContainer.style.top = "100px";

    let shape = document.createElement("div");
    shape.className = "shape";
    if (tool === "role") {
      shape.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="150" height="100">' +
              '<text id="text-id" x="25" y="50">' + name + '</text>' +
              '<polygon class="role-shape" points="75,0 150,50 75,100 0,50" style="fill:none;stroke:black"/>' +
              '</svg>';
      shape.type = "role";
      shape.name = "role-" + name;

      //shapeContainer.classList.add(`shape-role-${name}`);
      roleList.push({name: "role-" + name, type: "role", mother: ""});
    }
    if (tool === "user") {
      shape.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="90" height="45">' +
        '<text id="text-id" x="10" y="40">' + name + '</text>' +
        '<rect class="user-shape" x="0" y="0" width="90" height="45" style="fill:none;stroke:black"/>' +
        '</svg>';
      shape.type = "user";
      shape.attribute = "";
      shape.name = "user-" + name;

      //shapeContainer.classList.add(`shape-user-${name}`);
      userList.push({name: "user-" + name, type: "user", attribute: shape.attribute, mother: ""});
    }
    if (tool === "operation") {
      shape.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100" height="100">' +
        '<text id="text-id" x="10" y="50">' + name + '</text>' +
        '<rect class="operation-shape" x="0" y="0" width="100" height="100" style="fill:none;stroke:black"/> </svg>';
      shape.type = "operation";
      shape.name = "operation-" + name;

      //shapeContainer.classList.add(`shape-operation-${name}`);
      operationList.push({name: "operation-" + name, type: "operation", mother: ""});
    }


    shapeContainer.appendChild(shape);

    shapeContainer.classList.add(`shape-${name}`);

    document.body.appendChild(shapeContainer);
    makeDraggable(shapeContainer);
  }

  function rename(shape, newName) {
    if (shape.type === "role") {
      if (roleList.some(r => r.name === newName)) {
        alert(`The role ${newName} already exists!`);
        return;
      }
      else {
        shape.name = newName;
      }
    }
    if (shape.type === "operation") {
      if (operationList.some(r => r.name === newName)) {
        alert(`The operation ${newName} already exists!`);
        return;
      }
      else {
        shape.name = newName;
      }
    }
    else {
      shape.name = newName;
    }
  }

  let clickedShape = null;

  function handleContextMenu(e) {
    e.preventDefault();

    clickedShape = e.target.closest(".shape");

    // CHECK THIS
    let clickedLine = e.target.closest(".svgLine");
    // console.log(clickedLine);

    // console.log(clickedShape)
    if (clickedShape === null && clickedLine === null) {
      return;
    }

    if (clickedShape !== null) {
      showShapeContextMenu(e, clickedShape);
      return;
    }

    if (clickedLine != null) {
      showConnectionContextMenu(e, clickedLine);
      return;
    }

    hideContextMenu();
  }

  function showShapeContextMenu(e, clickedShape) {
    const contextMenu = document.createElement("div");
    contextMenu.className = "context-menu";
    if (clickedShape.type === "role" || clickedShape.type === "operation") {
      contextMenu.innerHTML = '<ul>' +
              '<li onclick="renameShape()">Rename</li>' +
              '<li onclick="deleteShape()">Delete</li>' +
              '<li onclick="hideContextMenu()">Hide Menu</li>' +
              '<li onclick="addChildConnection()">Add Child Connection</li>' +
              '</ul>';
    }

    if (clickedShape.type === "user") {
      contextMenu.innerHTML = '<ul>' +
              '<li onclick="renameShape()">Rename</li>' +
              '<li onclick="deleteShape()">Delete</li>' +
              '<li onclick="showAttribute()">Show Attribute</li>' +
              '<li onclick="configureAttribute()">Configure Attribute</li>' +
              '<li onclick="hideContextMenu()">Hide Menu</li>' +
              '</ul>';
    }

    contextMenu.style.position = "absolute";
    contextMenu.style.left = e.clientX + "px";
    contextMenu.style.top = e.clientY + "px";
    contextMenu.id = "contextMenu";
    document.body.appendChild(contextMenu);
  }

  function renameShape() {
    // console.log("rename");
    const newName = prompt("Enter the new name for the shape:", clickedShape.textContent);
    if (newName !== null) {
      const oldName = clickedShape.textContent;
      rename(clickedShape, newName);
      clickedShape.querySelector("#text-id").textContent = newName;

      if (clickedShape.type === "role") {
        const roleIndex = roleList.findIndex(role => role.name === oldName);
        if (roleIndex !== -1) {
          roleList[roleIndex].name = newName;
        }
      } else if (clickedShape.type === "operation") {
        const operationIndex = operationList.findIndex(operation => operation.name === oldName);
        if (operationIndex !== -1) {
          operationList[operationIndex].name = newName;
        }
      } else if (clickedShape.type === "user") {
        const userIndex = userList.findIndex(user => user.name === oldName);
        if (userIndex !== -1) {
          userList[userIndex].name = newName;
        }
      }
    }
    cleanupContextMenu();
  }

  function deleteShape() {
    if (confirm("Are you sure to delete this shape?")) {
      const shapeName = clickedShape.textContent;
      clickedShape.parentElement.remove();

      if (clickedShape.type === "role") {
        roleList = roleList.filter(role => role.name !== shapeName);
      } else if (clickedShape.type === "operation") {
        operationList = operationList.filter(operation => operation.name !== shapeName);
      } else if (clickedShape.type === "user") {
        userList = userList.filter(user => user.name !== shapeName);
      }

      connections = connections.filter(connection => {
        const {from, to} = connection;
        return !(from === clickedShape || to === clickedShape);
      });

      connections.forEach(connection => {
        connection.line.remove();
      });
      connections = connections.filter(connection => connection.from !== clickedShape && connection.to !== clickedShape);
    }
    cleanupContextMenu();
  }


  function cleanupContextMenu() {
    const contextMenu = document.querySelector(".context-menu");
    if (contextMenu) {
      contextMenu.remove();
    }
  }

  function showAttribute() {
    confirm(`The attribute of this user is ${clickedShape.attribute}`);
    cleanupContextMenu();
  }

  function configureAttribute() {
    const newAttribute = prompt("Please insert the new attribute of the user:", clickedShape.attribute);
    if (newAttribute !== null) {
      if (confirm(`Are you sure to configure the new attribute as ${newAttribute} from ${clickedShape.attribute} on ${clickedShape.name}`)) {
        const oldAttribute = clickedShape.attribute;
        clickedShape.attribute = newAttribute;
        const userIndex = userList.findIndex(user => user.attribute === oldAttribute);
        if (userIndex !== -1) {
          userList[userIndex].name = newAttribute;
        }
      }
    }
    cleanupContextMenu();
  }

  function hideContextMenu() {
    const contextMenu = document.querySelector(".context-menu");
    if (contextMenu) {
      contextMenu.remove();
    }
  }

  function addChildConnection() {
    if (clickedShape === null) {
      return;
    }

    const finishPoint = prompt("Enter the name of the child to connect:");
    if (finishPoint === null) {
      return;
    }

    let targetShape = document.querySelector(`.shape-${finishPoint}`);

    console.log(targetShape.getElementsByClassName('shape'));

    if (!targetShape) {
      alert(`Child with the name "${finishPoint}" not found!`);
      return;
    }

    let roleIndex;
    if (targetShape.getElementsByClassName('shape')[0].type === "role") {
      //targetShape = document.querySelector(`.shape-role-${finishPoint}`);
      console.log(targetShape.getElementsByClassName('shape')[0].name);
      console.log(roleList);
      roleIndex = roleList.findIndex((obj => obj.name === targetShape.getElementsByClassName('shape')[0].name));
      console.log(roleIndex);
      roleList[roleIndex].mother = clickedShape.name;
    }

    let userIndex;
    if (targetShape.getElementsByClassName('shape')[0].type === "user") {
      //targetShape = document.querySelector(`.shape-user-${finishPoint}`);
      userIndex = userList.findIndex((obj => obj.name === targetShape.getElementsByClassName('shape')[0].name));
      console.log(userIndex);
      userList[userIndex].mother = clickedShape.name;
    }

    let operationIndex;
    if (targetShape.getElementsByClassName('shape')[0].type === "operation") {
      //targetShape = document.querySelector(`.shape-operation-${finishPoint}`);
      operationIndex = operationList.findIndex((obj => obj.name === targetShape.getElementsByClassName('shape')[0].name));
      console.log(operationIndex);
      operationList[operationIndex].mother = clickedShape.name;
    }

    console.log(roleList);
    console.log(userList);
    console.log(operationList);

    const clickedShapeRect = clickedShape.getBoundingClientRect();
    const targetShapeRect = targetShape.getBoundingClientRect();

    const startX = clickedShapeRect.x > targetShapeRect.x ? clickedShapeRect.left : clickedShapeRect.right;
    const startY = clickedShapeRect.top + clickedShapeRect.height / 2;
    const endX = clickedShapeRect.x > targetShapeRect.x ? targetShapeRect.right : targetShapeRect.left;
    const endY = targetShapeRect.top + targetShapeRect.height / 2;

    const dx = endX - startX;
    const dy = endY - startY;
    // const length = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx);

    const svgLine = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svgLine.setAttribute("width", "100%");
    svgLine.setAttribute("height", "100%");
    svgLine.style.position = "absolute";
    svgLine.style.top = "0";
    svgLine.style.left = "0";

    // svgLine.className = "connection";

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", startX);
    line.setAttribute("y1", startY);
    line.setAttribute("x2", endX);
    line.setAttribute("y2", endY);
    line.setAttribute("stroke", "black");
    line.setAttribute("stroke-width", "2");

    const arrowSize = 10;
    const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    arrow.setAttribute(
            "points",
            `${endX},${endY} ${endX - arrowSize * Math.cos(angle - Math.PI / 6)},${
                    endY - arrowSize * Math.sin(angle - Math.PI / 6)
            } ${endX - arrowSize * Math.cos(angle + Math.PI / 6)},${
                    endY - arrowSize * Math.sin(angle + Math.PI / 6)
            }`
    );
    arrow.setAttribute("fill", "black");

    line.addEventListener("contextmenu", (e) => showConnectionContextMenu(e, connection));

    svgLine.appendChild(line);
    svgLine.appendChild(arrow);

    // svgLine.addEventListener("contextmenu", (e) => handleConnectionContextMenu(e, connection));

    document.body.appendChild(svgLine);

    const connection = {
      startX,
      startY,
      endX,
      endY,
      line: svgLine,
      from: clickedShape.parentNode,
      to: targetShape,
    };

    connections.push(connection);

    cleanupContextMenu();
    clickedShape = null;

  }

  function showConnectionContextMenu(e, connection) {
    e.preventDefault();

    const contextMenu = document.createElement("div");
    contextMenu.className = "context-menu";
    contextMenu.innerHTML = '<ul>' +
            `<li onclick="deleteConnection(${connections.indexOf(connection)})">Delete Connection</li>` +
            '<li onclick="cleanupConnectionContextMenu()">Hide Menu</li> ' +
            '</ul>';

    contextMenu.style.position = "absolute";
    contextMenu.style.left = e.clientX + "px";
    contextMenu.style.top = e.clientY + "px";
    contextMenu.id = "connectionContextMenu";
    document.body.appendChild(contextMenu);

  }

  function deleteConnection(index) {
    // console.log(connections);
    if (index !== -1) {
      const connection = connections[index];
      // console.log(connection);
      connection.line.remove();
      connections.splice(index, 1);
    }
    cleanupConnectionContextMenu();
  }

  function cleanupConnectionContextMenu() {
    const contextMenu = document.querySelector("#connectContextMenu");
    if (contextMenu) {
      contextMenu.remove();
    }
  }

  function updateConnections() {
    // console.log(connections);
    const arrowSize = 10;

    /*connections = connections.filter(connection => {
      const { from, to } = connection;
      const fromExists = document.contains(from);
      const toExists = document.contains(to);
      return fromExists && toExists;
    });

    const existingLines = document.querySelectorAll("svg");
    existingLines.forEach(line => {
      if (!connections.some(connection => connection.line === line)) {
        line.remove();
      }
    });*/

    for (const connection of connections) {
      const { startX, startY, endX, endY, line } = connection;
      const fromRect = connection.from.getBoundingClientRect();
      const toRect = connection.to.getBoundingClientRect();

      const newStartX = fromRect.x > toRect.x ? fromRect.left: fromRect.right;
      const newStartY = fromRect.top + fromRect.height / 2;
      const newEndX = fromRect.x > toRect.x ? toRect.right: toRect.left;
      const newEndY = toRect.top + toRect.height / 2;

      const dx = newEndX - newStartX;
      const dy = newEndY - newStartY;
      // const length = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx);

      line.querySelector("line").setAttribute("x1", newStartX);
      line.querySelector("line").setAttribute("y1", newStartY);
      line.querySelector("line").setAttribute("x2", newEndX);
      line.querySelector("line").setAttribute("y2", newEndY);
      line.querySelector("polygon").setAttribute(
              "points",
              `${newEndX},${newEndY} ${newEndX - arrowSize * Math.cos(angle - Math.PI / 6)},${
                      newEndY - arrowSize * Math.sin(angle - Math.PI / 6)
              } ${newEndX - arrowSize * Math.cos(angle + Math.PI / 6)},${
                      newEndY - arrowSize * Math.sin(angle + Math.PI / 6)
              }`
      );
    }
  }

  // document.addEventListener("mousemove", updateConnections);

  document.addEventListener("contextmenu", handleContextMenu);

  /*document.addEventListener("mousedown", function (event) {
    if (event.button !== 2) {
      // console.log("hide");
      hideContextMenu();
    }
  });*/

  document.addEventListener("click", function (event) {
    hideContextMenu();
    cleanupConnectionContextMenu();
  });

</script>

</body>
</html>
